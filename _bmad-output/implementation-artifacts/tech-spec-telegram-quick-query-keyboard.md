---
title: 'Быстрые запросы через клавиатуру Telegram'
slug: 'telegram-quick-query-keyboard'
created: '2026-01-10T23:26:32+0300'
status: 'completed'
stepsCompleted: [1, 2, 3, 4, 5]
implemented: '2026-01-11'
tech_stack: ['python-telegram-bot>=20.0', 'ReplyKeyboardMarkup', 'KeyboardButton', 'Python async/await']
files_to_modify: ['telegram_bot.py', 'tests/test_telegram_bot.py']
code_patterns: ['async handlers', 'CommandHandler', 'MessageHandler', 'filters.TEXT & ~filters.COMMAND', 'reply_markup parameter']
test_patterns: ['pytest', 'AsyncMock', 'MagicMock', 'tests/test_telegram_bot.py']
---

# Tech-Spec: Быстрые запросы через клавиатуру Telegram

**Created:** 2026-01-10T23:26:32+0300

## Overview

### Problem Statement

Пользователь часто запрашивает повторяющиеся запросы типа "Планы на сегодня", "Планы на неделю", "Что на выходных" и т.д. Каждый раз приходится вводить текст вручную, что неудобно. Нужен способ быстро отправлять популярные запросы одним нажатием кнопки в Telegram.

### Solution

Добавить клавиатуру (ReplyKeyboardMarkup) с фиксированным набором популярных запросов. Клавиатура открывается по команде (например, `/keyboard` или кнопка в меню). При нажатии на кнопку клавиатуры текст запроса отправляется как обычное сообщение и обрабатывается существующим обработчиком `handle_message`. После ответа бота клавиатура остается видимой до тех пор, пока пользователь не закроет её вручную.

### Scope

**In Scope:**
- Создание ReplyKeyboardMarkup с фиксированным набором популярных запросов
- Команда для показа клавиатуры (например, `/keyboard`)
- Отображение клавиатуры при команде `/start` (опционально, для удобства)
- Обработка нажатий кнопок через существующий MessageHandler
- Сохранение клавиатуры видимой после ответов бота (добавление `reply_markup` в ответы)
- Интеграция с текущей архитектурой бота без изменения логики обработки сообщений

**Out of Scope:**
- Динамическое управление кнопками (добавление/удаление пользователем)
- Сохранение пользовательских запросов в БД
- Настройка кнопок через команды бота
- Автоматическое скрытие клавиатуры (пользователь может закрыть её вручную)

## Context for Development

### Codebase Patterns

- **Библиотека**: `python-telegram-bot>=20.0` (современная версия с async поддержкой)
- **Обработчики команд**: `CommandHandler("start", start_command)` и `CommandHandler("reset", reset_command)`
- **Обработчик текстовых сообщений**: `MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message)`
- **Все обработчики асинхронные**: используют `async def` и `await`
- **Обработка сообщений**: Сообщения передаются агенту через `agent.arun()` с изоляцией по `user_id` и `session_id`
- **Хранение состояния**: Используется `application.bot_data` для хранения агента и `session_versions`
- **Отправка сообщений**: Методы `reply_text()` и `send_message()` принимают параметр `reply_markup`
- **Важно**: Кнопки ReplyKeyboardMarkup автоматически отправляют текст как обычное сообщение, поэтому они будут обрабатываться через существующий `handle_message` без изменений
- **Импорты**: Из `telegram` импортируются `Update`, из `telegram.ext` - `Application`, `CommandHandler`, `MessageHandler`, `filters`, `ContextTypes`
- **Нет существующего использования клавиатур**: В коде нет примеров использования `ReplyKeyboardMarkup` - это будет новое

### Files to Reference

| File | Purpose |
| ---- | ------- |
| `telegram_bot.py` | Основной файл с обработчиками бота. Нужно: создать функцию `create_quick_query_keyboard()`, обновить `start_command()` для отправки клавиатуры |
| `main.py` | Создание агента и запуск бота, может потребоваться для тестирования |
| `tests/test_telegram_bot.py` | Тесты для telegram_bot.py. Использует pytest с AsyncMock. Нужно добавить тесты для клавиатуры |
| `requirements.txt` | Зависимости проекта. `python-telegram-bot>=20.0` уже присутствует |

### Technical Decisions

1. **ReplyKeyboardMarkup vs InlineKeyboardButton**: Выбран ReplyKeyboardMarkup для отображения клавиатуры внизу экрана (оптимизировано для iOS)
2. **Фиксированный набор запросов**: На первом этапе используем предопределенный список популярных запросов (4 кнопки)
3. **Обработка через существующий handler**: Кнопки ReplyKeyboardMarkup автоматически отправляют текст как обычное сообщение, обрабатываются через существующий `handle_message` - **никаких изменений в обработчике не требуется**
4. **Команда для показа клавиатуры**: Добавить команду `/keyboard` для показа клавиатуры. Также показывать клавиатуру при `/start` для удобства
5. **Сохранение клавиатуры после ответов**: При отправке ответов ботом добавлять `reply_markup=create_quick_query_keyboard()` чтобы клавиатура оставалась видимой
6. **Структура клавиатуры**: Используем `KeyboardButton` для создания кнопок, `ReplyKeyboardMarkup` для группировки. Организовать в 2 ряда по 2 кнопки для лучшей читаемости на iOS
7. **Импорты**: Нужно добавить импорты `ReplyKeyboardMarkup` и `KeyboardButton` из `telegram`
8. **Тестирование**: Добавить тесты в `tests/test_telegram_bot.py` для проверки создания клавиатуры, команды `/keyboard` и отображения в `/start`
9. **Платформа**: Клавиатура оптимизирована для iOS, но должна работать на всех платформах Telegram

## Implementation Plan

### Tasks

- [x] Task 1: Добавить импорты для клавиатуры
  - File: `telegram_bot.py`
  - Action: Добавить в импорты из `telegram`: `ReplyKeyboardMarkup`, `KeyboardButton`
  - Notes: Импорты должны быть добавлены в начало файла вместе с существующими импортами из `telegram`

- [x] Task 2: Создать функцию для генерации клавиатуры
  - File: `telegram_bot.py`
  - Action: Создать функцию `create_quick_query_keyboard()` которая возвращает `ReplyKeyboardMarkup` с кнопками:
    - "Планы на сегодня"
    - "Планы на завтра"
    - "Планы на неделю"
    - "Что на выходных"
  - Notes: Функция должна быть синхронной, возвращать `ReplyKeyboardMarkup` с `KeyboardButton` объектами. Можно организовать кнопки в 2 ряда (по 2 кнопки в каждом) для лучшей читаемости. Использовать `resize_keyboard=True` для компактного отображения.

- [x] Task 3: Создать команду /keyboard для показа клавиатуры
  - File: `telegram_bot.py`
  - Action: Создать функцию `keyboard_command()` которая отправляет сообщение с клавиатурой через `reply_markup=create_quick_query_keyboard()`
  - Notes: Команда должна быть зарегистрирована в `run_bot()` через `CommandHandler("keyboard", keyboard_command)`

- [x] Task 4: Обновить функцию start_command для отображения клавиатуры
  - File: `telegram_bot.py`
  - Action: В функции `start_command()` добавить параметр `reply_markup=create_quick_query_keyboard()` в вызов `update.message.reply_text()`
  - Notes: Клавиатура должна отображаться вместе с приветственным сообщением при команде `/start` для удобства

- [x] Task 5: Обновить handle_message для сохранения клавиатуры после ответов
  - File: `telegram_bot.py`
  - Action: В функции `handle_message()` при отправке ответа через `update.message.reply_text()` добавить параметр `reply_markup=create_quick_query_keyboard()`
  - Notes: Это обеспечит сохранение клавиатуры видимой после каждого ответа бота

- [x] Task 6: Добавить тест для создания клавиатуры
  - File: `tests/test_telegram_bot.py`
  - Action: Создать тест `test_create_quick_query_keyboard()` который проверяет:
    - Функция возвращает `ReplyKeyboardMarkup`
    - Клавиатура содержит ожидаемые кнопки (4 кнопки с правильными текстами)
  - Notes: Использовать существующий паттерн тестирования с pytest

- [x] Task 7: Добавить тест для команды /keyboard
  - File: `tests/test_telegram_bot.py`
  - Action: Создать тест `test_keyboard_command()` который проверяет:
    - При вызове `/keyboard` отправляется сообщение с клавиатурой
    - В `reply_text()` передается параметр `reply_markup` с экземпляром `ReplyKeyboardMarkup`
  - Notes: Использовать `AsyncMock` и проверять аргументы вызова `reply_text`

- [x] Task 8: Добавить тест для отображения клавиатуры в /start
  - File: `tests/test_telegram_bot.py`
  - Action: Обновить существующий тест `test_start_command_with_agent()` или создать новый тест, который проверяет:
    - При вызове `/start` в `reply_text()` передается параметр `reply_markup`
    - `reply_markup` является экземпляром `ReplyKeyboardMarkup`
  - Notes: Использовать `AsyncMock` и проверять аргументы вызова `reply_text`

- [x] Task 9: Добавить тест для обработки нажатий кнопок
  - File: `tests/test_telegram_bot.py`
  - Action: Создать тест `test_handle_message_keyboard_button()` который проверяет:
    - Когда пользователь нажимает кнопку (текст сообщения = "Планы на сегодня"), сообщение обрабатывается через `handle_message`
    - Агент получает правильный текст запроса
  - Notes: Кнопки отправляют текст как обычные сообщения, поэтому существующий `handle_message` должен обработать их без изменений

### Acceptance Criteria

- [x] AC 1: Given пользователь отправляет команду `/keyboard`, when бот обрабатывает команду, then внизу экрана отображается клавиатура с 4 кнопками: "Планы на сегодня", "Планы на завтра", "Планы на неделю", "Что на выходных"

- [x] AC 2: Given пользователь отправляет команду `/start`, when бот отправляет приветственное сообщение, then внизу экрана также отображается клавиатура с 4 кнопками (для удобства)

- [x] AC 3: Given клавиатура отображается в чате, when пользователь нажимает на кнопку "Планы на сегодня", then текст "Планы на сегодня" отправляется как обычное сообщение и обрабатывается ботом через существующий обработчик `handle_message`

- [x] AC 4: Given клавиатура отображается в чате, when пользователь нажимает на любую из кнопок ("Планы на завтра", "Планы на неделю", "Что на выходных"), then соответствующий текст отправляется и обрабатывается корректно

- [x] AC 5: Given пользователь нажал на кнопку клавиатуры, when бот обрабатывает запрос и отправляет ответ, then клавиатура остается видимой после ответа (через `reply_markup` в ответе)

- [x] AC 6: Given клавиатура отображается в чате, when пользователь отправляет обычное текстовое сообщение (не через кнопку), then сообщение обрабатывается как обычно, клавиатура остается видимой (если была показана ранее)

- [x] AC 7: Given клавиатура создана функцией `create_quick_query_keyboard()`, when проверяется структура клавиатуры, then она содержит ровно 4 кнопки с правильными текстами, организованными в 2 ряда по 2 кнопки для оптимального отображения на iOS

## Additional Context

### Dependencies

- `python-telegram-bot` - уже используется в проекте
- Никаких новых зависимостей не требуется

### Testing Strategy

**Unit Tests:**
- Тест создания клавиатуры: проверка что функция `create_quick_query_keyboard()` возвращает правильную структуру с 4 кнопками
- Тест команды `/keyboard`: проверка что команда отправляет сообщение с клавиатурой
- Тест отображения в `/start`: проверка что `start_command()` передает клавиатуру в `reply_text()`
- Тест сохранения клавиатуры: проверка что `handle_message()` добавляет `reply_markup` в ответы
- Тест обработки нажатий: проверка что текст с кнопок обрабатывается через `handle_message` корректно

**Integration Tests:**
- Полный flow: `/keyboard` → отображение клавиатуры → нажатие кнопки → обработка запроса агентом → получение ответа с сохранением клавиатуры
- Альтернативный flow: `/start` → отображение клавиатуры → нажатие кнопки → обработка запроса → сохранение клавиатуры

**Manual Testing (iOS):**
1. Запустить бота через `./run.sh`
2. Открыть чат с ботом в Telegram на iOS устройстве
3. Отправить команду `/keyboard`
4. Проверить что клавиатура отображается внизу экрана корректно (2 ряда по 2 кнопки)
5. Нажать на каждую кнопку и проверить что запрос обрабатывается корректно
6. Проверить что после ответа бота клавиатура остается видимой
7. Отправить команду `/start` и проверить что клавиатура также показывается
8. Отправить обычное текстовое сообщение и проверить что клавиатура остается видимой (если была показана)

### Notes

**Реализация:**
- Популярные запросы для кнопок (финальный список):
  - "Планы на сегодня"
  - "Планы на завтра"
  - "Планы на неделю"
  - "Что на выходных"
- Клавиатура должна быть компактной: использовать `resize_keyboard=True` для автоматического изменения размера
- Структура: 2 ряда по 2 кнопки для оптимального отображения на iOS устройствах
- Тексты кнопок должны точно соответствовать тем запросам, которые пользователь обычно вводит вручную
- Команда `/keyboard` для показа клавиатуры по запросу пользователя
- Клавиатура также показывается при `/start` для удобства новых пользователей

**Известные ограничения:**
- Набор кнопок фиксированный - пользователь не может добавлять свои запросы (на первом этапе)
- Пользователь может закрыть клавиатуру вручную в Telegram - для повторного показа нужно отправить `/keyboard` или `/start`
- Клавиатура показывается только при явных командах - не автоматически при каждом сообщении

**Будущие улучшения (out of scope):**
- Динамическое управление кнопками через команды бота
- Сохранение пользовательских запросов в БД для персонализации
- Анализ частоты использования запросов для автоматического предложения популярных кнопок
- Автоматическое показ клавиатуры при определенных условиях
## Implementation Summary

**Дата реализации:** 2026-01-11

**Статус:** ✅ Завершено и протестировано

**Реализованные компоненты:**
1. ✅ Функция `create_quick_query_keyboard()` - создает клавиатуру с 4 кнопками в 2 ряда
2. ✅ Команда `/keyboard` - показывает клавиатуру по запросу пользователя
3. ✅ Интеграция клавиатуры в команду `/start` - автоматический показ при старте
4. ✅ Сохранение клавиатуры в ответах `handle_message()` - клавиатура остается видимой после каждого ответа
5. ✅ Добавлена клавиатура во все ответы бота (включая сообщения об ошибках)

**Тесты:**
- ✅ `test_create_quick_query_keyboard` - проверка создания клавиатуры
- ✅ `test_keyboard_command` - проверка команды `/keyboard`
- ✅ `test_handle_message_preserves_keyboard` - проверка сохранения клавиатуры
- ✅ `test_handle_message_keyboard_button` - проверка обработки нажатий кнопок

**Проверено вручную:**
- ✅ Клавиатура отображается при команде `/keyboard`
- ✅ Клавиатура отображается при команде `/start`
- ✅ Нажатия кнопок обрабатываются корректно
- ✅ Клавиатура остается видимой после ответов бота

**Измененные файлы:**
- `telegram_bot.py` - добавлена функциональность клавиатуры
- `tests/test_telegram_bot.py` - добавлены тесты для клавиатуры
