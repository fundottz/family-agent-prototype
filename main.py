"""–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è —Å–µ–º–µ–π–Ω–æ–≥–æ –ò–ò-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞."""

import os
import logging
from dotenv import load_dotenv
from agno.agent import Agent
from agno.models.deepseek import DeepSeek
from agno.db.sqlite import SqliteDb
from telegram_bot import run_bot
from core_logic.database import init_database
from agents_wrappers import (
    check_availability,
    schedule_event,
    get_current_datetime,
    get_agenda,
    update_event,
    cancel_events,
)

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO,
)
logger = logging.getLogger(__name__)


def create_family_planner_agent() -> Agent:
    """
    –°–æ–∑–¥–∞–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∞–≥–µ–Ω—Ç–∞ —Å–µ–º–µ–π–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞.
    
    –ù–∞ –ò—Ç–µ—Ä–∞—Ü–∏–∏ 3: –∞–≥–µ–Ω—Ç —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º.
    """
    # –ü–æ–ª—É—á–∞–µ–º API –∫–ª—é—á DeepSeek
    deepseek_api_key = os.getenv("DEEPSEEK_API_KEY")
    if not deepseek_api_key:
        raise ValueError("DEEPSEEK_API_KEY must be set in .env file")
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º SQLite –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    db_file = os.getenv("DB_FILE", "family_calendar.db")
    logger.info(f"–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {db_file}")
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç)
    init_database(db_file)

    # –°–æ–∑–¥–∞–µ–º –∞–≥–µ–Ω—Ç–∞ —Å DeepSeek –º–æ–¥–µ–ª—å—é
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å DeepSeek –≤–º–µ—Å—Ç–æ OpenAIChat
    agent = Agent(
        name="Family Planner",
        model=DeepSeek(
            id="deepseek-chat",
            api_key=deepseek_api_key,
            base_url="https://api.deepseek.com",
        ),
        instructions="""–¢—ã –≤–µ–∂–ª–∏–≤—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –¥–ª—è —Å–µ–º—å–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–µ–ª–∞, –Ω–∞—Ö–æ–¥–∏—Ç—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è—Ö –∏ —Ä–∞–∑—Ä–µ—à–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.

–ö–õ–Æ–ß–ï–í–´–ï –ü–†–ò–ù–¶–ò–ü–´:
1. –ì–æ–≤–æ—Ä–∏ —Å–ø–æ–∫–æ–π–Ω–æ, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ, –±–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ "–∑–∞–¥–∞—á–∞", "—Å—Ç–∞—Ç—É—Å", "ID", "–¥–µ–¥–ª–∞–π–Ω".
2. –ü–æ–Ω–∏–º–∞–π –ø–ª–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞ –Ω–∞–ø—Ä—è–º—É—é –∏ –≤—ã–∑—ã–≤–∞–π schedule_event —Å –Ω—É–∂–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (title, datetime, category, duration_minutes).
3. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - —Å–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–í–æ —Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –ø—Ä–æ–¥–ª–∏—Ç—Å—è —Å–µ–∫—Ü–∏—è?" –∏–ª–∏ "–ù–µ –ø–æ–Ω—è–ª –¥–∞—Ç—É, —É—Ç–æ—á–Ω–∏ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞").
4. –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø–µ—Ä–µ–¥ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
5. –ì–æ–≤–æ—Ä–∏ —á–µ—Ç–∫–æ –∏ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ "—Å—É–±–±–æ—Ç–∞ 10:00" –∏–ª–∏ "—Å—Ä–µ–¥–∞ 19:00" (–≤—Å–µ–≥–¥–∞ –º–æ—Å–∫–æ–≤—Å–∫–æ–µ –≤—Ä–µ–º—è).
6. –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π –ù–ï –ø–∏—à–∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–µ. –ù–ï –ø–∏—à–∏ "–Ø –ø–æ–º–æ–≥—É...", "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—é...", "–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—é...", "–í—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–Ω–æ", "–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–Ω–µ—Å—É...", "–û—Ç–ª–∏—á–Ω–æ! –°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ...". –ü—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –≤—ã–ø–æ–ª–Ω–∏ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ (check_availability, update_event), –∑–∞—Ç–µ–º —Å–æ–æ–±—â–∏ –¢–û–õ–¨–ö–û —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–¥–Ω–æ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏.

–ü–†–ò–ú–ï–ß–ê–ù–ò–ï –ü–û –ò–ù–°–¢–†–£–ú–ï–ù–¢–ê–ú:
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å—Ç—Ä–æ–≥–æ –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç/–≤—Ä–µ–º–µ–Ω–∏ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π. –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π ‚Äî –ø–æ–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏ –ø–æ–ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–∏—Ç—å.
- –î–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è "—Å–µ–≥–æ–¥–Ω—è/–∑–∞–≤—Ç—Ä–∞/–¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏" –∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–µ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π get_current_datetime (Europe/Moscow) –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã.
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–π —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ–≥–æ Telegram ID.
- –î–ª—è –ø–æ–≤–µ—Å—Ç–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π get_agenda(target_date). –≠—Ç–æ –æ–±—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å: –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤–∏–¥–Ω—ã –æ–±–æ–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º.
- –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É–π update_event(event_id, updates). –¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è –º–æ–∂–µ—Ç –µ–≥–æ –æ–±–Ω–æ–≤–ª—è—Ç—å. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ö–†–ò–¢–ò–ß–ù–û: –í—ã–ø–æ–ª–Ω—è–π –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (check_availability, update_event) –º–æ–ª—á–∞, –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –ø—Ä–æ—Ü–µ—Å—Å–µ. –°–æ–æ–±—â–∏ —Ç–æ–ª—å–∫–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
- –î–ª—è –æ—Ç–º–µ–Ω—ã —Å–æ–±—ã—Ç–∏–π –∏—Å–ø–æ–ª—å–∑—É–π cancel_events. –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ event_ids –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç (start_date/end_date –≤ ISO —Ñ–æ—Ä–º–∞—Ç–µ "YYYY-MM-DD") —Å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –Ω–∞–∑–≤–∞–Ω–∏—é.

–û–ë–©–ò–ô –ö–ê–õ–ï–ù–î–ê–†–¨ (–í–ê–ñ–ù–û):
- –≠—Ç–æ –æ–¥–∏–Ω –æ–±—â–∏–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å: –ª—é–±—ã–µ —Å–æ–±—ã—Ç–∏—è (–≤–∫–ª—é—á–∞—è "—É –º–µ–Ω—è...") –≤–∏–¥–Ω—ã –æ–±–æ–∏–º –ø–∞—Ä—Ç–Ω–µ—Ä–∞–º –∏ –±–ª–æ–∫–∏—Ä—É—é—Ç –≤—Ä–µ–º—è –¥–ª—è –≤—Å–µ—Ö.
- –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–æ–±—ã—Ç–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç "–º—ã/–≤–º–µ—Å—Ç–µ" ‚Äî —Å—Ç–∞–≤—å participant_scope='both', –∏–Ω–∞—á–µ participant_scope='self'.
- –ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–æ–±—ã—Ç–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–π check_availability, –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç ‚Äî —ç—Ç–æ –∫–æ–Ω—Ñ–ª–∏–∫—Ç –æ–±—â–µ–≥–æ –∫–∞–ª–µ–Ω–¥–∞—Ä—è.

–í–ê–ñ–ù–û:
- Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Å–∏—Å—Ç–µ–º–æ–π. –ù–ï –ø–µ—Ä–µ–¥–∞–≤–∞–π telegram_id –∏–ª–∏ creator_telegram_id —è–≤–Ω–æ –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã ‚Äî –æ–Ω–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
- –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç "–º—ã/–≤–º–µ—Å—Ç–µ/—Å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–º" ‚Äî —Å—Ç–∞–≤—å participant_scope='both', –∏–Ω–∞—á–µ participant_scope='self'.

–ü–†–ò–ú–ï–†–´ –ü–†–ê–í–ò–õ–¨–ù–´–• –û–¢–í–ï–¢–û–í:
‚úÖ "–ó–∞–ø–æ–º–Ω–∏–ª: —Å–µ–∫—Ü–∏—è —É —Å—ã–Ω–∞, —Å—É–±–±–æ—Ç–∞ 10:00. –ù–∞–ø–æ–º–Ω—é –≤ –ø—è—Ç–Ω–∏—Ü—É."
‚úÖ "–°–µ–≥–æ–¥–Ω—è —Å–ø–æ–∫–æ–π–Ω—ã–π –¥–µ–Ω—å: —Å–µ–∫—Ü–∏—è –≤ 10, —É–±–æ—Ä–∫–∞ –≤ 11."
‚úÖ "–¢—É—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –ø–ª–∞–Ω–æ–º –∂–µ–Ω—ã –Ω–∞ —Å—Ä–µ–¥—É 19:00 (–≤—Å—Ç—Ä–µ—á–∞ —Å –¥–µ–≤–æ—á–∫–∞–º–∏). –ß—Ç–æ –¥–µ–ª–∞–µ–º?"
‚úÖ "–ü–ª–∞–Ω—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞:
- 10:00-11:00 –≤—Å—Ç—Ä–µ—á–∞
- 14:00-15:00 –≤—Ä–∞—á
–°–≤–æ–±–æ–¥–Ω–æ –ø–æ—Å–ª–µ 15:00."
‚úÖ "–°–∞–º–æ–ª–µ—Ç –≤ –ú–æ—Å–∫–≤—É 9 —è–Ω–≤–∞—Ä—è —Å 15:00 –¥–æ 19:00 –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –Ω–∞ 11 —è–Ω–≤–∞—Ä—è —Å 12:00 –¥–æ 15:00 —Å –Ω–æ–≤—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º "–°–∞–º–æ–ª–µ—Ç –≤ –ü–µ–Ω–∑—É"."

–ü–†–ò–ú–ï–†–´ –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–• –û–¢–í–ï–¢–û–í:
‚ùå "–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞. –°—Ç–∞—Ç—É—Å: proposed. ID: 123"
‚ùå "Event scheduled for 2024-01-13T10:00:00Z"
‚ùå "–ù–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å" (–≤—Å–µ–≥–¥–∞ –∑–∞–¥–∞–≤–∞–π —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã)
‚ùå "–°–∫–∞–∂–∏ —Å–≤–æ–π Telegram ID" (ID –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è)
‚ùå "–°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—é...", "–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—é...", "–í—Ä–µ–º—è –¥–æ—Å—Ç—É–ø–Ω–æ", "–¢–µ–ø–µ—Ä—å –ø–µ—Ä–µ–Ω–µ—Å—É...", "–û—Ç–ª–∏—á–Ω–æ! –°–æ–±—ã—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ..." (–≤—Å–µ —ç—Ç–æ –ª–∏—à–Ω–µ–µ)""",
        system_message="""–ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤:

1. –ü–∏—à–∏ –æ–±—ã—á–Ω—ã–º —á–∏—Ç–∞–µ–º—ã–º —Ç–µ–∫—Å—Ç–æ–º
2. –í—Å–µ–≥–¥–∞ —Å—Ç–∞–≤—å –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏, –∑–∞–ø—è—Ç–æ–π –∏ –¥—Ä—É–≥–∏—Ö –∑–Ω–∞–∫–æ–≤ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
3. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π markdown-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (**—Ç–µ–∫—Å—Ç**), –∫—É—Ä—Å–∏–≤ (*—Ç–µ–∫—Å—Ç*), –∑–∞–≥–æ–ª–æ–≤–∫–∏ (## –∑–∞–≥–æ–ª–æ–≤–æ–∫)
4. –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏
5. –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ —Å–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ –¥–µ—Ñ–∏—Å –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏

–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
"–°–µ–≥–æ–¥–Ω—è —Å—Ä–µ–¥–∞. –£ –≤–∞—Å —Ç—Ä–∏ –¥–µ–ª–∞: –≤—Å—Ç—Ä–µ—á–∞ –≤ 10:00, –≤—Ä–∞—á –≤ 14:00, –±–∞—Å—Å–µ–π–Ω –≤ 19:00."
"–ü–ª–∞–Ω—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞:
- 10:00 –≤—Å—Ç—Ä–µ—á–∞
- 14:00 –≤—Ä–∞—á"

–ü—Ä–∏–º–µ—Ä—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
"–°–µ–≥–æ–¥–Ω—è —Å—Ä–µ–¥–∞.–£ –≤–∞—Å —Ç—Ä–∏ –¥–µ–ª–∞" (–Ω–µ—Ç –ø—Ä–æ–±–µ–ª–∞ –ø–æ—Å–ª–µ —Ç–æ—á–∫–∏)
"**–ü–ª–∞–Ω—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞:**" (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç)
"üìÖ 10:00" (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã —ç–º–æ–¥–∑–∏)""",
        tools=[
            check_availability,
            schedule_event,
            get_current_datetime,
            get_agenda,
            update_event,
            cancel_events,
        ],
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º SQLite –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–æ–≤
        db=SqliteDb(db_file=db_file),
        add_history_to_context=True,
        markdown=False,
        debug_mode=True
    )
    
    return agent


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞."""
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ —Å–µ–º–µ–π–Ω–æ–≥–æ –ò–ò-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞...")
    print("üöÄ –ó–∞–ø—É—Å–∫ —Å–µ–º–µ–π–Ω–æ–≥–æ –ò–ò-–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞...")
    
    try:
        # –°–æ–∑–¥–∞–µ–º –∞–≥–µ–Ω—Ç–∞
        logger.info("–°–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞...")
        agent = create_family_planner_agent()
        logger.info("‚úÖ –ê–≥–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω")
        print("‚úÖ –ê–≥–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º Telegram –±–æ—Ç–∞
        # run_bot –∏—Å–ø–æ–ª—å–∑—É–µ—Ç application.run_polling(), –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç event loop
        logger.info("üì± –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...")
        print("üì± –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞...")
        run_bot(agent)
    except KeyboardInterrupt:
        logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏")
        print("\nüõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞...")
    except ValueError as e:
        logger.error(f"–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        print(f"‚ùå –û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: {e}")
        raise
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}", exc_info=True)
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
        raise


if __name__ == "__main__":
    main()
